##%######################################################%##
#                                                          #
####    Etude de la relation entre ateliers de production  ####
###       et biodiversité autour des exploitations         ###
##                   agricoles définies                    ###
##             Date : Août 2024                            ##
#                                                          #
##%######################################################%##

###---------------------------------------------------------#
cli::cli_h1("Productions et biodiversité")

#### Identification des ateliers de productions ####
cli::cli_h2("Identification des ateliers")

prod_ea <- utils::read.csv(file = "Data/Brutes/desc_ea.csv", 
                           h = TRUE,
                           sep = ",")

ateliers <- utils::read.csv(file = "Data/Brutes/ateliers_prod.csv", 
                           h = TRUE,
                           sep = ";")

prod_sinp <- base::merge(sinp_ea_2km, prod_ea, 
                         by.x = "Code_EA", 
                         by.y = "Code_EA")

cli::cli_h2("Définition des groupes d'ateliers")
##### Groupe A #####
groups_prodA <- prod_sinp %>%
  dplyr::mutate(annees = as.numeric(substr(date, 1,4))) %>%
  dplyr::group_by(Production_A, cdnom) %>%
  dplyr::summarise(nombre = n()) %>%
  sf::st_drop_geometry()

groups_prodA <- base::merge(groups_prodA, ateliers, 
                            by.x = "Production_A", 
                            by.y = "Production")

data_prodA <- reshape2::dcast(groups_prodA,
                              Code_prod ~ cdnom,
                              value.var = "nombre",
                              fun.aggregate = sum)

##### Groupe B #####
groups_prodB <- prod_sinp %>%
  dplyr::mutate(annees = as.numeric(substr(date, 1,4))) %>%
  dplyr::group_by(Production_B, cdnom) %>%
  dplyr::summarise(nombre = n()) %>%
  sf::st_drop_geometry()

groups_prodB <- groups_prodB[!(groups_prodB$Production_B == ""), ]

groups_prodB <- base::merge(groups_prodB, ateliers, 
                            by.x = "Production_B", 
                            by.y = "Production")

data_prodB <- reshape2::dcast(groups_prodB,
                              Code_prod ~ cdnom,
                              value.var = "nombre",
                              fun.aggregate = sum)

##### Groupe C #####
groups_prodC <- prod_sinp %>%
  dplyr::mutate(annees = as.numeric(substr(date, 1,4))) %>%
  dplyr::group_by(Production_C, cdnom) %>%
  dplyr::summarise(nombre = n()) %>%
  sf::st_drop_geometry()

groups_prodC <- groups_prodC[!(groups_prodC$Production_C == ""), ]

groups_prodC <- base::merge(groups_prodC, ateliers, 
                            by.x = "Production_C", 
                            by.y = "Production")

data_prodC <- reshape2::dcast(groups_prodC,
                              Code_prod ~ cdnom,
                              value.var = "nombre",
                              fun.aggregate = sum)


biodiv_A <- indic_biodiv(data_biodiv = data_prodA, 
                         code = data_prodA$Code_prod)
biodiv_B <- indic_biodiv(data_biodiv = data_prodB, 
                         code = data_prodB$Code_prod)
biodiv_C <- indic_biodiv(data_biodiv = data_prodC, 
                         code = data_prodC$Code_prod)

library(ggpubr)

biodiv_A$code <- as.factor(biodiv_A$code)
levels(biodiv_A$code)
modell <- lm(Rs ~ code, data = biodiv_A)
ggboxplot(biodiv_A, x = "code", y = "Rs")
ggqqplot(residuals(model))

##### Analyse factorielle des données mixtes #####  
cli::cli_h2("AFDM")

afmd <- FAMD(prod_ind)

##### Analyse en composantes principales (ACP) #####
cli::cli_h2("ACP")

acp <- FactoMineR::PCA( X = recap_tests_bio)


