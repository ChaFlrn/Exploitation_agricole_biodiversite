##%######################################################%##
#                                                          #
####   Caractérisation simple de la biodiversité           ####
###     pour chaque exploitation agricole étudiée          ###
##             Date : Avril 2024                           ##
#                                                          #
##%######################################################%##

###---------------------------------------------------------#
#### Caractérisation générale de la biodiversité ####
cli::cli_h1("Nombre de données par exploitation")
cli::cli_h2("Rayon de 2km")

sinp_ea_2km$cdnom = as.numeric(sinp_ea_2km$cdNom)

nb_obs_2km <- sinp_ea_2km %>%
  dplyr::mutate(annees = as.numeric(substr(date, 1,4))) %>%
  dplyr::group_by(Code_EA, Exploit) %>%
  dplyr::summarise(nombre = n()) %>%
  sf::st_drop_geometry()

###---------------------------------------------------------#
cli::cli_h2("Rayon de 5km")

sinp_ea_5km$cdnom = as.numeric(sinp_ea_5km$cdNom)

nb_obs_5km <- sinp_ea_5km %>%
  dplyr::mutate(annees = as.numeric(substr(date, 1,4))) %>%
  dplyr::group_by(Code_EA, Exploit) %>%
  dplyr::summarise(nombre = n()) %>%
  sf::st_drop_geometry()

###---------------------------------------------------------#
recap_nb_obs <- merge(x = nb_obs_2km,
                      y = nb_obs_5km,
                      by = "Code_EA")

recap_nb_obs <- recap_nb_obs %>%
  dplyr::select(Code_EA,
                Exploitation = Exploit.x,
                Nb_obs_2km = nombre.x,
                Nb_obs_5km = nombre.y)

###---------------------------------------------------------#
cli::cli_h1("Classification des espèces observées")

type_obs_5km <- sinp_ea_5km %>%
  dplyr::group_by(regne, ordre, cdNom) %>%
  dplyr::summarise(nb_obs = n()) %>%
  dplyr::group_by(regne, ordre) %>%
  dplyr::summarise(nb_esp = n(),
                   nb_obs = sum(nb_obs)) %>%
  dplyr::group_by(regne) %>%
  dplyr::summarise(nb_ordre = n(),
                   nb_esp = sum(nb_esp),
                   nb_obs = sum(nb_obs)) %>%
  sf::st_drop_geometry()

type_obs_2km <- sinp_ea_2km %>%
  dplyr::group_by(regne, ordre, cdNom) %>%
  dplyr::summarise(nb_obs = n()) %>%
  dplyr::group_by(regne, ordre) %>%
  dplyr::summarise(nb_esp = n(),
                   nb_obs = sum(nb_obs)) %>%
  dplyr::group_by(regne) %>%
  dplyr::summarise(nb_ordre = n(),
                   nb_esp = sum(nb_esp),
                   nb_obs = sum(nb_obs)) %>%
  sf::st_drop_geometry()


###---------------------------------------------------------#
cli::cli_h1("Identification des espèces dominantes")

esp_dom_5km <- sinp_ea_5km %>%
  dplyr::group_by(regne, cdNom) %>%
  dplyr::summarise(nombre = n()) %>%
  dplyr::arrange(-nombre, .by_group = TRUE) %>%
  dplyr::slice(1:5) %>%
  dplyr::mutate(pourcentage = nombre / sum(nombre) * 100) %>%
  dplyr::mutate(across(where(is.numeric), ~ round(., 2))) %>%
  dplyr::mutate(rang = c(1:5)) %>%
  dplyr::ungroup()%>%
  sf::st_drop_geometry()


esp_dom_2km <- sinp_ea_2km %>%
  dplyr::group_by(regne, cdNom) %>%
  dplyr::summarise(nombre = n()) %>%
  dplyr::arrange(-nombre, .by_group = TRUE) %>%
  dplyr::slice(1:5) %>%
  dplyr::mutate(pourcentage = nombre / sum(nombre) * 100) %>%
  dplyr::mutate(across(where(is.numeric), ~ round(., 2))) %>%
  dplyr::mutate(rang = c(1:5)) %>%
  dplyr::ungroup()%>%
  sf::st_drop_geometry()








###---------------------------------------------------------#
#### La biodiversité autour des exploitations agricoles ####
cli::cli_h1("Indices de biodiversité")
cli::cli_h2("Rayon de 2km")

# Mise en place du tableau pour les calculs d'indice de biodiversité #
data_tests_bio_2km <- sinp_ea_2km %>%
  dplyr::group_by(Code_EA, cdnom) %>%
  dplyr::summarise(nb = n()) %>%
  sf::st_drop_geometry()

data_tests_bio_2km <- reshape2::dcast(data_tests_bio_2km,
                                  Code_EA ~ cdnom,
                                  value.var = "nb",
                                  fun.aggregate = sum)

cli::cli_h2("Rayon de 5km")
# Mise en place du tableau pour les calculs d'indice de biodiversité #
data_tests_bio_5km <- sinp_ea_5km %>%
  dplyr::group_by(Code_EA, cdnom) %>%
  dplyr::summarise(nb = n()) %>%
  sf::st_drop_geometry()

data_tests_bio_5km <- reshape2::dcast(data_tests_bio_5km,
                                      Code_EA ~ cdnom,
                                      value.var = "nb",
                                      fun.aggregate = sum)

##### Indices de biodiversité (Rs, D, H, E) #####
cli::cli_h3("Calcul indicateurs biodiversité par exploitations")
biodiv_ea_2km <- indic_biodiv(data_biodiv = data_tests_bio_2km, 
                              code = data_tests_bio$Code_EA)

biodiv_ea_5km <- indic_biodiv(data_biodiv = data_tests_bio_5km, 
                          code = data_tests_bio$Code_EA)



cli::cli_h2("Indice de Jaccard")
##### Indice de Jaccard - I #####
indice_jaccard <-  vegan::vegdist(data_tests_bio_5km, 
                                  method = "jaccard", 
                                  binary = FALSE)
indice_jaccard




