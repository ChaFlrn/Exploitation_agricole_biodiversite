##%######################################################%##
#                                                          #
####   Récupération des bases de données                ####
###     Nettoyage et homogénéisation des variables       ###
##             Date : Avril 2024                           ##
#                                                          #
##%######################################################%##

###---------------------------------------------------------#
cli::cli_h1("Import des données naturalistes")

###---------------------------------------------------------#

#### Inventaire National du Patrimoine Naturel #### ------------------------------------------
cli::cli_h2("Données SINP")

data_sinp <- utils::read.csv(file = "Data/Brutes/SINP/St_Principal.csv", 
                             h = TRUE,
                             sep = ";")


##### Jointure pour récupérer l'emsemble des informations #####
point <- sf :: st_read("Data/Spatiales/SINP/point.shp") %>%
  sf::st_transform(crs = 2154)

ligne <- sf::st_read("Data/Spatiales/SINP/ligne.shp") %>%
  sf::st_transform(crs = 2154)

polygone <- sf::st_read("Data/Spatiales/SINP/polygone.shp") %>%
  sf::st_transform(crs = 2154)

coord_obs <- base::rbind(point, ligne, polygone)


sinp <- base::merge(data_sinp, coord_obs, by.x = "cleObjet", by.y = "cleObjet", all = TRUE)


##### Nettoyage et précision des données #####
sinp <- sinp %>%
  dplyr::select(cleObs,
                cleGrp,
                cdNom,
                nomCite,
                dateDebut,
                identObs,
                geometry)

sinp$date <- lubridate::ymd(sinp$dateDebut)

sinp <- sinp %>%
  dplyr::filter(!is.na(date))

sinp[sinp$date < "2014-01-01", "Periode"] <- "historique"
sinp[sinp$date >= "2014-01-01" & sinp$date < "2024-01-01", "Periode"] <- "voulue"
sinp[sinp$date >= "2024-01-01", "Periode"] <- "futur"

sinp <- dplyr::filter(sinp, Periode == "voulue")


##### Identification des groupes taxonomiques #####
taxref <- utils::read.csv(file = "Data/Brutes/TAXREF_v17_2024/TAXREFv17.txt",
                          h = TRUE,
                          sep = "")

taxref <- taxref %>%
  dplyr::select(CD_NOM,
                REGNE,
                CLASSE,
                ORDRE,
                FAMILLE,
                SOUS_FAMILLE)


sinp <- merge(sinp, taxref, by.x = "cdNom", by.y = "CD_NOM", all = FALSE)

sinp <- sinp %>%
  dplyr::select(cleObs,
                cdNom,
                nomCite,
                date,
                regne = REGNE,
                classe = CLASSE,
                ordre = ORDRE,
                famille = FAMILLE,
                geometry)

##### Vérification de la présence de doublons #####
sinp <- sinp[!duplicated(sinp$cleObs), ]


sinp <- sf::st_as_sf(sinp)






