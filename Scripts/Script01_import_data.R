##%######################################################%##
#                                                          #
####   Récupération des bases de données                ####
###     Nettoyage et homogénéisation des variables       ###
##             Date : Avril 2024                           ##
#                                                          #
##%######################################################%##

###---------------------------------------------------------#
cli::cli_h1("Import des données naturalistes")

###---------------------------------------------------------#

## Observatoire de l'Environnement en Bretagne ####
cli::cli_h2("Données OEB")

##### Chargement du fichier #####
data_oeb <- utils::read.csv("Data/synthese_observations.csv", 
                            h = TRUE, 
                            dec = ",", 
                            sep = ";") 

##### Précision des données #####
oeb <- data_oeb %>%
  dplyr::select(
    id_synthese,
    cd_ref,
    cd_nom,
    date_debut,
    nom_valide,
    nom_vernaculaire,
    nom_cite,
    regne,
    group2_inpn,
    classe,
    ordre,
    famille,
    rang_taxo,
    nombre_min,
    nombre_max,
    observateurs,
    communes,
    niveau_validation,
    validateur,
    geometrie_wkt_4326,
    x_centroid_4326,
    y_centroid_4326
  )

oeb[oeb$date_debut < "2014-01-01" , "Periode"] <- "historique"  
oeb[oeb$date_debut >= "2014-01-01" & oeb$date_debut < "2024-01-01", "Periode"] <- "voulue"
oeb[oeb$date_debut >= "2024-01-01", "Periode"] <- "futur" 

oeb <- dplyr::filter(oeb, Periode == "voulue")

##### Sélection des données valides #####

oeb[oeb$niveau_validation == "Certain - très probable", "Validation"] <- "valide" 
oeb[oeb$niveau_validation == "Probable", "Validation"] <- "valide"
oeb[oeb$niveau_validation == "Douteux", "Validation"] <- "non_valide"
oeb[oeb$niveau_validation == "En attente de validation", "Validation"] <- "valide"

oeb <- dplyr::filter(oeb, Validation == "valide")

##### Vérfication de la présence de doublons #####
oeb <- oeb[!duplicated(oeb$id_synthese), ]


###---------------------------------------------------------#

#### Inventaire National du Patrimoine Naturel #### ------------------------------------------
cli::cli_h2("Données SINP")

data_sinp <- utils::read.csv(file = "Data/Brutes/SINP/St_Principal.csv", 
                             h = TRUE,
                             sep = ";")


##### Jointure pour récupérer l'emsemble des informations #####
point <- sf :: st_read("Data/Spatiales/SINP/point.shp") %>%
  sf::st_transform(crs = 2154)

ligne <- sf::st_read("Data/Spatiales/SINP/ligne.shp") %>%
  sf::st_transform(crs = 2154)

polygone <- sf::st_read("Data/Spatiales/SINP/polygone.shp") %>%
  sf::st_transform(crs = 2154)


sinp <- base::merge(data_sinp, point, by.x = "cleObjet", by.y = "cleObjet", all = TRUE)

sinp <- base::merge(sinp, ligne, by.x = "cleObjet", by.y = "cleObjet", all = TRUE)

sinp <- base::merge(sinp, polygone, by.x = "cleObjet", by.y = "cleObjet", all = TRUE)


data_dpt <- utils::read.csv(file = "Data/Brutes/SINP/St_Departements.csv", 
                            h = TRUE, 
                            sep = ";")


data_communes <- utils::read.csv(file = "Data/Brutes/SINP/St_Communes.csv",
                                 h = TRUE,
                                 sep = ";")

sinp <- merge(sinp, data_dpt, by.x = "cleObs", by.y = "cleObs", all = TRUE)

sinp <- merge(sinp, data_communes, by.x = "cleObs", by.y = "cleObs", all = TRUE)

##### Nettoyage et précision des données #####
sinp <- sinp %>%
  dplyr::select(cleObs,
                cleGrp,
                cdNom,
                nomCite,
                dateDebut,
                identObs,
                geometry,
                geometry.x,
                geometry.y)

sinp$date <- lubridate::ymd(sinp$dateDebut)

sinp <- sinp %>%
  dplyr::filter(!is.na(date))

sinp[sinp$date < "2014-01-01", "Periode"] <- "historique"
sinp[sinp$date >= "2014-01-01" & sinp$date < "2024-01-01", "Periode"] <- "voulue"
sinp[sinp$date >= "2024-01-01", "Periode"] <- "futur"

sinp <- dplyr::filter(sinp, Periode == "voulue")


##### Identification des groupes taxonomiques #####
taxref <- utils::read.csv(file = "Data/Brutes/TAXREF_v17_2024/TAXREFv17.txt",
                          h = TRUE,
                          sep = "")

taxref <- taxref %>%
  dplyr::select(CD_NOM,
                REGNE,
                CLASSE,
                ORDRE,
                FAMILLE,
                SOUS_FAMILLE,
                GROUP1_INPN,
                GROUP2_INPN,
                GROUP3_INPN)


sinp <- merge(sinp, taxref, by.x = "cdNom", by.y = "CD_NOM", all.x = TRUE, all.y = FALSE)

sinp <- sinp %>%
  dplyr::select(cleObs,
                cdNom,
                nomCite,
                date,
                regne = REGNE,
                classe = CLASSE,
                ordre = ORDRE,
                famille = FAMILLE,
                GROUP1_INPN,
                GROUP2_INPN,
                GROUP3_INPN,
                geometry,
                geometry.x,
                geometry.y)


animalia <- dplyr::filter(sinp, regne == "Animalia")
plantae <- dplyr::filter(sinp, regne == "Plantae")
fungi <- dplyr::filter(sinp, regne == "Fungi")




